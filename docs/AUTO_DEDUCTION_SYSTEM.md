# ๐ ูุธุงู ุงูุฎุตููุงุช ุงูุชููุงุฆูุฉ ููุญุถูุฑ ูุงูุงูุตุฑุงู

## ูุธุฑุฉ ุนุงูุฉ

ูุธุงู ูุชูุงูู ูุฅุฏุงุฑุฉ ุงูุชุฃุฎูุฑ ูุงูุงูุตุฑุงู ุงููุจูุฑ ูุน ุฎุตููุงุช ุชููุงุฆูุฉ ููุธุงู ุชุตุนูุฏ ูุฑุตูุฏ ุชุณุงูุญ ุดูุฑู ูุงุจู ููุชุฎุตูุต.

## ุงููููุฒุงุช ุงูุฑุฆูุณูุฉ

โ **ุฑุตูุฏ ุชุณุงูุญ ุดูุฑู** - 60 ุฏูููุฉ ุงูุชุฑุงุถูุงู ููู ููุธู
โ **ูุธุงู ุงูุชุตุนูุฏ** - ุฎุตู ุนุงุฏูุ ูุถุงุนูุ ุซูุงุซู ูููุฎุงููุงุช ุงููุชูุฑุฑุฉ
โ **ุฎุตู ุงูุงูุตุฑุงู ุงููุจูุฑ** - ุฎุตู ููุฑู ูุฃู ุงูุตุฑุงู ูุจู ุงูููุนุฏ
โ **ุฅุดุนุงุฑุงุช ุชููุงุฆูุฉ** - ุชูุจููุงุช ุนูุฏ ุงูุชุฑุงุจ ููุงุฏ ุงูุฑุตูุฏ
โ **ุตูุงุญูุฉ ุงูุฅูุบุงุก** - ูููู ูููุฏูุฑ ุฅูุบุงุก ุงูุฎุตู ูู ุงูุธุฑูู ุงูุทุงุฑุฆุฉ
โ **ุชูุงุฑูุฑ ุดุงููุฉ** - ุฅุญุตุงุฆูุงุช ูุชูุงุฑูุฑ ุชูุตูููุฉ

## ุงููุชุทูุจุงุช ุงูุฃุณุงุณูุฉ

### ูุธุงู ุงููุฑููุฉ
- **ุฑุตูุฏ ุดูุฑู**: 60 ุฏูููุฉ ุงูุชุฑุงุถูุงู (ูุงุจู ููุชุฎุตูุต ููู ููุธู)
- **ุญุฏ ุฃูุตู ูููู**: 10 ุฏูุงุฆู (ูุง ูููู ุงูุฏุฎูู ุจุนุฏ 10:10 ุญุชู ูุน ูุฌูุฏ ุฑุตูุฏ)
- **ูุนุฏู ุงูุฎุตู**: ูุงุจู ููุชุฎุตูุต ููู ููุธู (ุฌููู/ุฏูููุฉ)

### ูุซุงู ุนููู
ููุธู ููุนุฏู ุงูุณุงุนุฉ 10:00 ุตุจุงุญุงู:
- โ ุฏุฎู 10:05 โ ุงุณุชุฎุฏุงู 5 ุฏูุงุฆู ูู ุงูุฑุตูุฏ (ูุง ุฎุตู)
- โ ุฏุฎู 10:10 โ ุงุณุชุฎุฏุงู 10 ุฏูุงุฆู ูู ุงูุฑุตูุฏ (ูุง ุฎุตู)
- โ ุฏุฎู 10:12 โ ุฎุตู ููุฑู ุนูู ุฏูููุชูู (ุชุฌุงูุฒ ุงูุญุฏ ุงููููู)
- โ ููุฏ ุงูุฑุตูุฏ ูุฏุฎู 10:05 โ ุฎุตู ุนูู 5 ุฏูุงุฆู

---

## ุงูุจููุฉ ุงูุชูููุฉ

### ูุงุนุฏุฉ ุงูุจูุงูุงุช

#### ุฌุฏูู User (ุชุญุฏูุซ)
```prisma
model User {
  // ... ุงูุญููู ุงูููุฌูุฏุฉ
  
  // ุฅุนุฏุงุฏุงุช ุงููุฑููุฉ
  monthlyGraceMinutes  Int?     @default(60)
  maxDailyLateMinutes  Int?     @default(10)
  lateDeductionRate    Decimal? @db.Decimal(10, 2)
  enableAutoDeduction  Boolean  @default(true)
}
```

#### ุฌุฏูู LatenessBalance (ุฌุฏูุฏ)
```prisma
model LatenessBalance {
  id                    String   @id @default(cuid())
  companyId             String
  employeeId            String
  month                 Int      // 1-12
  year                  Int
  totalLateMinutes      Int      @default(0)
  graceMinutesUsed      Int      @default(0)
  deductedMinutes       Int      @default(0)
  totalDeductionAmount  Decimal  @default(0)
  lateCount             Int      @default(0)
  
  @@unique([employeeId, month, year])
}
```

### ุงูุฎุฏูุงุช (Services)

#### 1. LatenessCalculationService
**ุงููููุน**: `backend/services/hr/latenessCalculationService.js`

**ุงููุธุงุฆู ุงูุฑุฆูุณูุฉ**:
- `calculateLateMinutes()` - ุญุณุงุจ ุฏูุงุฆู ุงูุชุฃุฎูุฑ
- `calculateDeduction()` - ุญุณุงุจ ุงูุฎุตู ุจูุงุกู ุนูู ุงููุฑููุฉ
- `getOrCreateMonthlyBalance()` - ุฌูุจ/ุฅูุดุงุก ุฑุตูุฏ ุงูุดูุฑ
- `updateMonthlyBalance()` - ุชุญุฏูุซ ุงูุฑุตูุฏ ุจุนุฏ ุงูุชุฃุฎูุฑ
- `getRemainingGraceMinutes()` - ุงูุฑุตูุฏ ุงููุชุจูู

#### 2. AutoDeductionService
**ุงููููุน**: `backend/services/hr/autoDeductionService.js`

**ุงููุธุงุฆู ุงูุฑุฆูุณูุฉ**:
- `processLateAttendance()` - ูุนุงูุฌุฉ ุงูุชุฃุฎูุฑ ูุฅูุดุงุก ุฎุตู
- `createAutoDeduction()` - ุฅูุดุงุก ุฎุตู ุชููุงุฆู
- `getEmployeeAutoDeductions()` - ุฌูุจ ุฎุตููุงุช ุงูููุธู
- `cancelAutoDeduction()` - ุฅูุบุงุก ุฎุตู (ุญุงูุงุช ุงุณุชุซูุงุฆูุฉ)

---

## ุขููุฉ ุงูุนูู

### 1. ุนูุฏ ุชุณุฌูู ุงูุญุถูุฑ

```javascript
// ูู attendanceService.checkIn()
1. ุญุณุงุจ ุฏูุงุฆู ุงูุชุฃุฎูุฑ
2. ุฅุฐุง ูุงู ููุงู ุชุฃุฎูุฑ:
   - ุงุณุชุฏุนุงุก autoDeductionService.processLateAttendance()
   - ุญุณุงุจ ุงูุฎุตู ุจูุงุกู ุนูู ุงููุฑููุฉ
   - ุชุญุฏูุซ ุฑุตูุฏ ุงููุฑููุฉ ุงูุดูุฑู
   - ุฅูุดุงุก ุฎุตู ุชููุงุฆู ุฅุฐุง ูุฒู ุงูุฃูุฑ
```

### 2. ูุนุงุฏูุฉ ุงูุญุณุงุจ

```
ุฏูุงุฆู_ุงูุชุฃุฎูุฑ = ููุช_ุงูุฏุฎูู_ุงููุนูู - ููุช_ุงูุฏุฎูู_ุงููุญุฏุฏ

ุฅุฐุง (ุฏูุงุฆู_ุงูุชุฃุฎูุฑ > ุงูุญุฏ_ุงูุฃูุตู_ุงููููู):
  ุฎุตู_ููุฑู = ุฏูุงุฆู_ุงูุชุฃุฎูุฑ - ุงูุญุฏ_ุงูุฃูุตู_ุงููููู
  ุฏูุงุฆู_ูุงุจูุฉ_ูููุฑููุฉ = ุงูุญุฏ_ุงูุฃูุตู_ุงููููู
ูุฅูุง:
  ุฎุตู_ููุฑู = 0
  ุฏูุงุฆู_ูุงุจูุฉ_ูููุฑููุฉ = ุฏูุงุฆู_ุงูุชุฃุฎูุฑ

ุฑุตูุฏ_ูุชุจูู = 60 - ุงููุฑููุฉ_ุงููุณุชุฎุฏูุฉ_ูุฐุง_ุงูุดูุฑ

ุฅุฐุง (ุฏูุงุฆู_ูุงุจูุฉ_ูููุฑููุฉ <= ุฑุตูุฏ_ูุชุจูู):
  ุงุณุชุฎุฏุงู_ูู_ุงูุฑุตูุฏ = ุฏูุงุฆู_ูุงุจูุฉ_ูููุฑููุฉ
  ุฎุตู_ุฅุถุงูู = 0
ูุฅูุง:
  ุงุณุชุฎุฏุงู_ูู_ุงูุฑุตูุฏ = ุฑุตูุฏ_ูุชุจูู
  ุฎุตู_ุฅุถุงูู = ุฏูุงุฆู_ูุงุจูุฉ_ูููุฑููุฉ - ุฑุตูุฏ_ูุชุจูู

ุฅุฌูุงูู_ุงูุฎุตู = (ุฎุตู_ููุฑู + ุฎุตู_ุฅุถุงูู) ร ูุนุฏู_ุงูุฎุตู
```

---

## API Endpoints

### ููููุธููู

#### ุงูุญุตูู ุนูู ุฑุตูุฏ ุงููุฑููุฉ
```http
GET /api/v1/hr/lateness/balance
Authorization: Bearer {token}

Response:
{
  "success": true,
  "balance": {
    "total": 60,
    "used": 25,
    "remaining": 35,
    "lateCount": 5,
    "totalDeducted": 0,
    "totalDeductionAmount": 0
  }
}
```

#### ุงูุญุตูู ุนูู ุงูุฎุตููุงุช ุงูุชููุงุฆูุฉ
```http
GET /api/v1/hr/lateness/auto-deductions?month=1&year=2026
Authorization: Bearer {token}

Response:
{
  "success": true,
  "deductions": [...],
  "count": 3,
  "totalAmount": 150.00
}
```

#### ุชูุฑูุฑ ุงูุชุฃุฎูุฑ ุงูุดูุฑู
```http
GET /api/v1/hr/lateness/report?month=1&year=2026
Authorization: Bearer {token}

Response:
{
  "success": true,
  "report": {
    "month": 1,
    "year": 2026,
    "totalLateMinutes": 45,
    "graceMinutesUsed": 35,
    "deductedMinutes": 10,
    "totalDeductionAmount": 50.00,
    "lateCount": 8
  }
}
```

### ููุฅุฏุงุฑุฉ (HR)

#### ุชุญุฏูุซ ุฅุนุฏุงุฏุงุช ููุธู
```http
PUT /api/v1/hr/lateness/settings/:employeeId
Authorization: Bearer {token}
Content-Type: application/json

{
  "monthlyGraceMinutes": 90,
  "maxDailyLateMinutes": 15,
  "lateDeductionRate": 5.00,
  "enableAutoDeduction": true
}

Response:
{
  "success": true,
  "employee": {
    "id": "...",
    "firstName": "ุฃุญูุฏ",
    "lastName": "ูุญูุฏ",
    "monthlyGraceMinutes": 90,
    "maxDailyLateMinutes": 15,
    "lateDeductionRate": 5.00,
    "enableAutoDeduction": true
  }
}
```

#### ุฅุญุตุงุฆูุงุช ุงูุดุฑูุฉ
```http
GET /api/v1/hr/lateness/stats?month=1&year=2026
Authorization: Bearer {token}

Response:
{
  "success": true,
  "stats": {
    "totalDeductions": 45,
    "totalAmount": 2250.00,
    "affectedEmployees": 12,
    "byEmployee": [...]
  }
}
```

#### ุฅูุบุงุก ุฎุตู ุชููุงุฆู
```http
POST /api/v1/hr/lateness/cancel-deduction/:deductionId
Authorization: Bearer {token}
Content-Type: application/json

{
  "reason": "ุฎุทุฃ ูู ุชุณุฌูู ุงูุญุถูุฑ - ูุงู ุงูููุธู ูู ูููุฉ ุฎุงุฑุฌูุฉ"
}

Response:
{
  "success": true,
  "deduction": {...}
}
```

---

## ุฎุทูุงุช ุงูุชูุนูู

### 1. ุชุดุบูู Migration
```bash
cd backend
npx prisma migrate dev --name add_auto_deduction_system
```

### 2. ุฅุนุงุฏุฉ ุชุดุบูู ุงูุฎุงุฏู
```bash
npm run dev
```

### 3. ุชุญุฏูุซ ุฅุนุฏุงุฏุงุช ุงูููุธููู (ุงุฎุชูุงุฑู)
ุงุณุชุฎุฏู API endpoint ูุชุฎุตูุต ุฅุนุฏุงุฏุงุช ููุธููู ูุญุฏุฏูู.

---

## ุฃูุซูุฉ ุงูุงุณุชุฎุฏุงู

### ุณููุงุฑูู 1: ููุธู ููุถุจุท
```
ุงูููุธู: ุฃุญูุฏ
ุงูุฑุตูุฏ ุงูุดูุฑู: 60 ุฏูููุฉ
ุงูุญุฏ ุงููููู: 10 ุฏูุงุฆู
ูุนุฏู ุงูุฎุตู: 5 ุฌููู/ุฏูููุฉ

ุงูููู 1: ุฏุฎู 10:05 โ ุงุณุชุฎุฏุงู 5 ุฏูุงุฆู (ุฑุตูุฏ ูุชุจูู: 55)
ุงูููู 2: ุฏุฎู 10:03 โ ุงุณุชุฎุฏุงู 3 ุฏูุงุฆู (ุฑุตูุฏ ูุชุจูู: 52)
ุงูููู 3: ุฏุฎู 10:08 โ ุงุณุชุฎุฏุงู 8 ุฏูุงุฆู (ุฑุตูุฏ ูุชุจูู: 44)

ุงููุชูุฌุฉ: ูุง ููุฌุฏ ุฎุตู โ
```

### ุณููุงุฑูู 2: ุชุฌุงูุฒ ุงูุญุฏ ุงููููู
```
ุงูููุธู: ูุญูุฏ
ุงูุฑุตูุฏ ุงููุชุจูู: 50 ุฏูููุฉ
ุฏุฎู ุงูุณุงุนุฉ: 10:15 (ุชุฃุฎุฑ 15 ุฏูููุฉ)

ุงูุญุณุงุจ:
- ุชุฌุงูุฒ ุงูุญุฏ ุงููููู: 15 - 10 = 5 ุฏูุงุฆู โ ุฎุตู ููุฑู
- ุฏูุงุฆู ูุงุจูุฉ ูููุฑููุฉ: 10 ุฏูุงุฆู
- ุงุณุชุฎุฏุงู ูู ุงูุฑุตูุฏ: 10 ุฏูุงุฆู
- ุฅุฌูุงูู ุงูุฎุตู: 5 ร 5 = 25 ุฌููู โ
```

### ุณููุงุฑูู 3: ููุงุฏ ุงูุฑุตูุฏ
```
ุงูููุธู: ูุงุทูุฉ
ุงูุฑุตูุฏ ุงููุชุจูู: 3 ุฏูุงุฆู
ุฏุฎู ุงูุณุงุนุฉ: 10:07 (ุชุฃุฎุฑ 7 ุฏูุงุฆู)

ุงูุญุณุงุจ:
- ุฏูุงุฆู ูุงุจูุฉ ูููุฑููุฉ: 7 ุฏูุงุฆู
- ุงุณุชุฎุฏุงู ูู ุงูุฑุตูุฏ: 3 ุฏูุงุฆู
- ุฎุตู ุฅุถุงูู: 7 - 3 = 4 ุฏูุงุฆู
- ุฅุฌูุงูู ุงูุฎุตู: 4 ร 5 = 20 ุฌููู โ
```

---

## ุงูุฅุนุฏุงุฏุงุช ุงูุงูุชุฑุงุถูุฉ

| ุงูุฅุนุฏุงุฏ | ุงููููุฉ ุงูุงูุชุฑุงุถูุฉ | ูุงุจู ููุชุฎุตูุต |
|---------|-------------------|---------------|
| ุฑุตูุฏ ุงููุฑููุฉ ุงูุดูุฑู | 60 ุฏูููุฉ | โ ููู ููุธู |
| ุงูุญุฏ ุงูุฃูุตู ุงููููู | 10 ุฏูุงุฆู | โ ููู ููุธู |
| ูุนุฏู ุงูุฎุตู | 0 ุฌููู/ุฏูููุฉ | โ ููู ููุธู |
| ุชูุนูู ุงูุฎุตู ุงูุชููุงุฆู | ููุนูู | โ ููู ููุธู |

---

## ููุงุญุธุงุช ูููุฉ

1. **ุงูุฎุตููุงุช ุงูุชููุงุฆูุฉ ููุงูู ุนูููุง ูุจุงุดุฑุฉ** - ูุง ุชุญุชุงุฌ ููุงููุฉ ูุฏููุฉ
2. **ูุชู ุฅูุดุงุก ุฑุตูุฏ ุฌุฏูุฏ ุชููุงุฆูุงู** ูู ุจุฏุงูุฉ ูู ุดูุฑ
3. **ูููู ุฅูุบุงุก ุงูุฎุตููุงุช** ูุจู ุชุทุจูููุง ุนูู ุงูุฑุงุชุจ
4. **ุงูุฎุตููุงุช ุงููุทุจูุฉ ุนูู ุงูุฑุงุชุจ** ูุง ูููู ุฅูุบุงุคูุง
5. **ุงููุธุงู ูุนูู ุชููุงุฆูุงู** ุนูุฏ ุชุณุฌูู ุงูุญุถูุฑ

---

## ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### ุงููุดููุฉ: ุงูุฎุตู ูุง ูุนูู
**ุงูุญู**: ุชุญูู ูู:
- `enableAutoDeduction` = true ููููุธู
- `lateDeductionRate` ูุญุฏุฏ ูุฃูุจุฑ ูู 0
- Migration ุชู ุชุดุบููู ุจูุฌุงุญ

### ุงููุดููุฉ: ุฑุตูุฏ ุงููุฑููุฉ ุบูุฑ ุตุญูุญ
**ุงูุญู**: 
- ุชุญูู ูู ุฌุฏูู `LatenessBalance`
- ุชุฃูุฏ ูู ุงูุดูุฑ ูุงูุณูุฉ ุงูุตุญูุญูู

### ุงููุดููุฉ: ุงูุฎุตู ุฃูุจุฑ ูู ุงููุชููุน
**ุงูุญู**:
- ุฑุงุฌุน `maxDailyLateMinutes` - ูุฏ ูููู ุงูููุธู ุชุฌุงูุฒ ุงูุญุฏ ุงููููู
- ุชุญูู ูู `lateDeductionRate`

---

## ุงูุชุทููุฑ ุงููุณุชูุจูู (ุงุฎุชูุงุฑู)

- [ ] ูุงุฌูุฉ Frontend ูุฅุฏุงุฑุฉ ุงูุฅุนุฏุงุฏุงุช
- [ ] ุชูุงุฑูุฑ ุชูุตูููุฉ ุจุงูุฑุณูู ุงูุจูุงููุฉ
- [ ] ุฅุดุนุงุฑุงุช WhatsApp ุนูุฏ ุงูุชุฑุงุจ ููุงุฏ ุงูุฑุตูุฏ
- [ ] ุชุตุฏูุฑ ุชูุงุฑูุฑ Excel
- [ ] ูุธุงู ุชูุจููุงุช ููููุธููู ุงููุชุฃุฎุฑูู ุงููุชูุฑุฑูู

---

## ุงูุฏุนู ุงูููู

ูููุณุงุนุฏุฉ ุฃู ุงูุงุณุชูุณุงุฑุงุชุ ุฑุงุฌุน:
- `backend/services/hr/latenessCalculationService.js`
- `backend/services/hr/autoDeductionService.js`
- `backend/controller/latenessController.js`
