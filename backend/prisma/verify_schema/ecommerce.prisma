model Customer {
  id                             String                          @id
  firstName                      String
  lastName                       String
  email                          String?
  phone                          String?
  avatar                         String?
  facebookId                     String?
  whatsappId                     String?
  telegramId                     String?
  status                         CustomersStatus                 @default(LEAD)
  tags                           String?
  notes                          String?
  metadata                       String?                         @db.Text
  companyId                      String
  createdAt                      DateTime                        @default(now())
  updatedAt                      DateTime
  customerRating                 CustomersCustomerRating         @default(UNKNOWN)
  successScore                   Float                           @default(0)
  deliveryRate                   Float                           @default(0)
  totalDelivered                 Int                             @default(0)
  totalOrdersCount               Int                             @default(0)
  activities                     Activity[]
  affiliate_referrals            AffiliateReferral[]
  aiInteractions                 AiInteraction[]
  appointments                   Appointment[]
  blockedCustomersOnPages        BlockedCustomersOnPage[]
  conversationOutcomes           ConversationOutcome[]
  conversations                  Conversation[]
  customerLoyaltyRecords         CustomerLoyaltyRecord[]
  customerNotes                  CustomerNote[]
  customerNotificationPreference CustomerNotificationPreference?
  companies                      Company                         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  orders                         Order[]
  returnRequests                 ReturnRequest[]
  whatsAppContacts               WhatsAppContact[]
  whatsapp_notification_logs     WhatsAppNotificationLog[]

  customerWallets CustomerWallet[] @relation

  @@unique([facebookId, companyId])
  @@unique([telegramId, companyId])
  @@unique([whatsappId, companyId])
  @@index([companyId])
  @@index([companyId, status])
  @@index([facebookId])
  @@index([status])
  @@map("customers")
}

model BackInStockNotification {
  id            String    @id
  productId     String
  companyId     String
  customerName  String
  customerEmail String?
  customerPhone String?
  notifyEmail   Boolean   @default(true)
  notifySMS     Boolean   @default(false)
  isNotified    Boolean   @default(false)
  notifiedAt    DateTime?
  createdAt     DateTime  @default(now())
  companies     Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  products      Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([isNotified])
  @@index([productId])
  @@map("back_in_stock_notifications")
}

model BlockedCustomersOnPage {
  id             String       @id
  facebookPageId String
  pageId         String
  customerId     String
  facebookId     String
  blockedBy      String?
  reason         String?      @db.Text
  blockedAt      DateTime     @default(now())
  createdAt      DateTime     @default(now())
  updatedAt      DateTime
  metadata       String?      @db.Text
  customers      Customer     @relation(fields: [customerId], references: [id], onDelete: Cascade)
  facebookPage   FacebookPage @relation(fields: [facebookPageId], references: [id], onDelete: Cascade)

  @@unique([facebookPageId, customerId])
  @@unique([pageId, facebookId])
  @@index([customerId])
  @@index([facebookId])
  @@index([facebookPageId])
  @@index([pageId])
  @@map("blocked_customers_on_page")
}

model Branche {
  id           String   @id
  name         String
  address      String?
  city         String?
  phone        String
  email        String?
  workingHours String?
  isActive     Boolean  @default(true)
  companyId    String
  createdAt    DateTime @default(now())
  updatedAt    DateTime
  companies    Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([isActive])
  @@map("branches")
}

model Category {
  id               String     @id
  name             String
  description      String?    @db.Text
  image            String?
  parentId         String?
  isActive         Boolean    @default(true)
  sortOrder        Int        @default(0)
  companyId        String
  createdAt        DateTime   @default(now())
  updatedAt        DateTime
  displayType      String     @default("default")
  metaDescription  String?    @db.Text
  metaTitle        String?
  slug             String?
  companies        Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  category         Category?  @relation("categoriesTocategories", fields: [parentId], references: [id])
  other_categories Category[] @relation("categoriesTocategories")
  products         Product[]

  @@unique([companyId, slug])
  @@index([companyId])
  @@index([parentId])
  @@index([slug])
  @@map("categories")
}

model CouponUsage {
  id             String   @id
  couponId       String
  companyId      String
  customerId     String?
  orderId        String?
  discountAmount Decimal  @db.Decimal(10, 2)
  orderAmount    Decimal  @db.Decimal(10, 2)
  usedAt         DateTime @default(now())
  coupon         Coupon   @relation(fields: [couponId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([couponId])
  @@index([customerId])
  @@index([orderId])
  @@index([usedAt])
  @@map("coupon_usages")
}

model Coupon {
  id                String        @id
  companyId         String
  code              String
  name              String
  description       String?       @db.Text
  type              CouponType    @default(PERCENTAGE)
  value             Decimal       @db.Decimal(10, 2)
  minOrderAmount    Decimal?      @db.Decimal(10, 2)
  maxDiscountAmount Decimal?      @db.Decimal(10, 2)
  usageLimit        Int?
  usageCount        Int           @default(0)
  userUsageLimit    Int?
  validFrom         DateTime
  validTo           DateTime
  isActive          Boolean       @default(true)
  customerSegments  String?       @db.Text
  metadata          String?       @db.Text
  createdBy         String?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime
  couponUsages      CouponUsage[]
  companies         Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, code])
  @@index([code])
  @@index([companyId])
  @@index([isActive])
  @@index([validFrom, validTo])
  @@map("coupons")
}

model CustomerList {
  id          String   @id
  name        String
  description String?  @db.Text
  criteria    String   @db.LongText
  count       Int      @default(0)
  isDefault   Boolean  @default(false)
  companyId   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime
  companies   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@map("customer_lists")
}

model CustomerNote {
  id         String   @id
  customerId String
  authorId   String
  content    String   @db.Text
  createdAt  DateTime @default(now())
  updatedAt  DateTime
  users      User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  customers  Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([authorId])
  @@index([customerId])
  @@map("customer_notes")
}

model DeliveryOption {
  id           String   @id
  name         String
  description  String?  @db.Text
  deliveryTime String
  price        Decimal  @db.Decimal(10, 2)
  isDefault    Boolean  @default(false)
  isActive     Boolean  @default(true)
  icon         String?
  sortOrder    Int      @default(0)
  companyId    String
  createdAt    DateTime @default(now())
  updatedAt    DateTime
  companies    Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([isActive])
  @@map("delivery_options")
}

model GuestCart {
  id        String   @id
  cartId    String   @unique
  items     String   @db.LongText
  total     Decimal  @default(0.00) @db.Decimal(10, 2)
  companyId String
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())
  expiresAt DateTime
  companies Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([cartId])
  @@index([companyId])
  @@index([expiresAt])
  @@map("guest_carts")
}

model GuestOrder {
  id                  String               @id
  orderNumber         String
  guestEmail          String
  guestPhone          String
  guestName           String
  items               String               @db.LongText
  total               Decimal              @db.Decimal(10, 2)
  shippingCost        Decimal              @default(0.00) @db.Decimal(10, 2)
  discountAmount      Decimal              @default(0.00) @db.Decimal(10, 2)
  finalTotal          Decimal              @db.Decimal(10, 2)
  shippingAddress     String               @db.LongText
  paymentMethod       String
  status              String               @default("pending")
  notes               String?              @db.Text
  companyId           String
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @default(now())
  isViewed            Boolean              @default(false)
  metadata            String?              @db.Text
  affiliateId         String?
  turboLabelUrl       String?              @db.Text
  turboMetadata       String?              @db.Text
  turboShipmentId     String?
  turboShipmentStatus String?
  turboTrackingNumber String?
  createdBy           String?
  createdByName       String?
  OrderStatusHistory  OrderStatusHistory[]
  affiliates          Affiliate?           @relation(fields: [affiliateId], references: [id])
  companies           Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)
  users               User?                @relation(fields: [createdBy], references: [id])
  orderNotes          OrderNote[]

  @@unique([companyId, orderNumber])
  @@index([affiliateId])
  @@index([companyId])
  @@index([createdAt])
  @@index([createdBy])
  @@index([guestEmail])
  @@index([orderNumber])
  @@index([status])
  @@index([turboShipmentId])
  @@index([turboTrackingNumber])
  @@map("guest_orders")
}

model InvoiceItem {
  id          String   @id
  invoiceId   String
  description String
  quantity    Float    @default(1)
  unitPrice   Float
  totalPrice  Float
  metadata    String?  @db.LongText
  createdAt   DateTime @default(now())
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@map("invoice_items")
}

model Invoice {
  id              String           @id
  invoiceNumber   String           @unique
  subscriptionId  String?
  companyId       String
  status          InvoicesStatus   @default(DRAFT)
  type            InvoiceType      @default(SUBSCRIPTION)
  issueDate       DateTime         @default(now())
  dueDate         DateTime
  paidDate        DateTime?
  subtotal        Float
  taxAmount       Float            @default(0)
  discountAmount  Float            @default(0)
  totalAmount     Float
  currency        String           @default("EGP")
  notes           String?
  paymentTerms    String?          @default("Net 30")
  metadata        String?          @db.LongText
  createdAt       DateTime         @default(now())
  updatedAt       DateTime
  invoiceItems    InvoiceItem[]
  companies       Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  subscription    Subscription?    @relation(fields: [subscriptionId], references: [id])
  paymentReceipts PaymentReceipt[]
  payments        Payment[]

  @@index([companyId])
  @@index([subscriptionId])
  @@map("invoices")
}

model OrderItem {
  id               String          @id
  orderId          String
  productId        String?
  quantity         Int
  price            Decimal         @db.Decimal(10, 2)
  total            Decimal         @db.Decimal(10, 2)
  productName      String?
  productColor     String?
  productSize      String?
  productSku       String?
  metadata         String?         @db.Text
  variantId        String?
  extractionSource String?         @default("ai")
  confidence       Float?
  productImage     String?
  productDetails   String?
  basePrice        Decimal?        @db.Decimal(10, 2)
  merchantPrice    Decimal?        @db.Decimal(10, 2)
  orders           Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  products         Product?        @relation(fields: [productId], references: [id], onDelete: Cascade)
  productVariant   ProductVariant? @relation(fields: [variantId], references: [id])

  @@index([orderId])
  @@index([productId])
  @@index([variantId])
  @@map("order_items")
}

model OrderNote {
  id           String      @id
  content      String      @db.Text
  orderId      String?
  guestOrderId String?
  authorId     String?
  authorName   String
  createdAt    DateTime    @default(now())
  users        User?       @relation(fields: [authorId], references: [id])
  guestOrder   GuestOrder? @relation(fields: [guestOrderId], references: [id])
  orders       Order?      @relation(fields: [orderId], references: [id])

  @@index([authorId])
  @@index([guestOrderId])
  @@index([orderId])
  @@map("order_notes")
}

model OrderStatusConfig {
  id                  String   @id
  companyId           String
  code                String
  name                String
  nameEn              String?
  description         String?  @db.Text
  color               String   @default("#6B7280")
  icon                String?
  sortOrder           Int      @default(0)
  statusType          String   @default("order")
  source              String   @default("system")
  isSystemStatus      Boolean  @default(false)
  isActive            Boolean  @default(true)
  mapsToSystem        String?
  wooCommerceStatus   String?
  allowedNextStatuses String?  @db.Text
  autoActions         String?  @db.Text
  notifyCustomer      Boolean  @default(false)
  notifyAdmin         Boolean  @default(false)
  emailTemplate       String?  @db.Text
  smsTemplate         String?  @db.Text
  createdAt           DateTime @default(now())
  updatedAt           DateTime
  companies           Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, code])
  @@index([companyId])
  @@index([source])
  @@index([statusType])
  @@map("order_status_configs")
}

model Order {
  id                     String                    @id @default(cuid())
  orderNumber            String
  customerId             String
  conversationId         String?
  status                 OrderStatus               @default(PENDING)
  isViewed               Boolean                   @default(false)
  paymentStatus          PaymentStatus             @default(PENDING)
  paymentMethod          PaymentMethod             @default(CASH)
  subtotal               Decimal                   @db.Decimal(10, 2)
  tax                    Decimal                   @default(0.00) @db.Decimal(10, 2)
  shipping               Decimal                   @default(0.00) @db.Decimal(10, 2)
  discount               Decimal                   @default(0.00) @db.Decimal(10, 2)
  total                  Decimal                   @db.Decimal(10, 2)
  currency               String                    @default("EGP")
  notes                  String?
  shippingAddress        String?                   @db.Text
  billingAddress         String?                   @db.Text
  customerName           String?
  customerPhone          String?
  customerEmail          String?
  city                   String?
  governorate            String?
  customerAddress        String?
  dataQuality            String?                   @db.Text
  extractionMethod       String?                   @default("ai_enhanced")
  confidence             Float?
  validationStatus       String?                   @default("pending")
  sourceType             String?                   @default("ai_conversation")
  extractionTimestamp    DateTime?
  metadata               String?                   @db.Text
  companyId              String
  createdAt              DateTime                  @default(now())
  updatedAt              DateTime                  @updatedAt
  lastSyncAt             DateTime?
  syncedFromWoo          Boolean                   @default(false)
  syncedToWoo            Boolean                   @default(false)
  wooCommerceDateCreated DateTime?
  wooCommerceId          String?
  wooCommerceOrderKey    String?
  wooCommerceStatus      String?
  wooCommerceUrl         String?
  turboBranchId          String?
  turboLabelUrl          String?
  statusHistory          OrderStatusHistory[]
  turboMetadata          String?                   @db.Text
  turboShipmentId        String?
  turboShipmentStatus    String?
  turboTrackingNumber    String?
  orderItems             OrderItem[]
  orderNotes             OrderNote[]
  company                Company                   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  conversation           Conversation?             @relation(fields: [conversationId], references: [id])
  customer               Customer                  @relation(fields: [customerId], references: [id], onDelete: Cascade)
  returnRequests         ReturnRequest[]
  callAttempts           Int                       @default(0)
  lastCallAttemptAt      DateTime?
  callAttemptLogs        CallAttemptLog[]
  orderInvoice           OrderInvoice?
  conversionEvents       ConversionEvent[]
  notificationLogs       WhatsAppNotificationLog[]

  scheduledDeliveryDate   DateTime?
  isScheduled             Boolean   @default(false)
  scheduledNotes          String?   @db.Text
  autoTransitionEnabled   Boolean   @default(true)
  scheduledTransitionedAt DateTime?

  // Affiliate & Dropshipping fields
  affiliateReferralId String?     @unique // ربط بالإحالة (إن كان الطلب عن طريق رابط)
  affiliateId         String? // ربط مباشر بالمسوق (للطلبات المباشرة أو الإحالات)
  merchantOrderId     String?     @unique // ربط بطلب التاجر
  isDropshipped       Boolean     @default(false)
  orderSource         OrderSource @default(REGULAR) // REGULAR, AFFILIATE_REFERRAL, AFFILIATE_DIRECT

  // Order Creator fields
  createdBy     String? // معرف المستخدم الذي أنشأ الطلب
  createdByName String? // اسم المستخدم الذي أنشأ الطلب

  affiliateReferral AffiliateReferral? @relation("OrderAffiliateReferral")
  affiliate         Affiliate?         @relation(fields: [affiliateId], references: [id])
  merchantOrder     MerchantOrder?     @relation("OrderMerchantOrder")
  commissions       Commission[]
  createdByUser     User?              @relation("OrderCreatedBy", fields: [createdBy], references: [id])

  // Wallet relations
  walletTransactions WalletTransaction[]

  userRel   User?   @relation(fields: [userRelId], references: [id])
  userRelId String?

  @@unique([companyId, orderNumber])
  @@index([affiliateId])
  @@index([companyId])
  @@index([conversationId])
  @@index([createdBy])
  @@index([customerId])
  @@index([isScheduled])
  @@index([orderSource])
  @@index([scheduledDeliveryDate])
  @@index([turboTrackingNumber])
  @@index([wooCommerceId])
  @@map("orders")
}

model PaymentReceipt {
  id             String       @id
  invoiceId      String
  walletNumberId String
  receiptImage   String
  status         String       @default("PENDING")
  submittedAt    DateTime     @default(now())
  reviewedAt     DateTime?
  reviewedBy     String?
  notes          String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime
  invoice        Invoice      @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  walletNumber   WalletNumber @relation(fields: [walletNumberId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@index([walletNumberId])
  @@map("payment_receipts")
}

model Payment {
  id               String         @id
  paymentNumber    String         @unique
  invoiceId        String?
  subscriptionId   String?
  companyId        String
  amount           Float
  currency         String         @default("EGP")
  status           PaymentsStatus @default(PENDING)
  method           PaymentsMethod @default(BANK_TRANSFER)
  gateway          String?
  gatewayPaymentId String?
  transactionId    String?
  paidAt           DateTime?
  failedAt         DateTime?
  failureReason    String?
  metadata         String?        @db.LongText
  createdAt        DateTime       @default(now())
  updatedAt        DateTime
  companies        Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  invoice          Invoice?       @relation(fields: [invoiceId], references: [id])
  subscription     Subscription?  @relation(fields: [subscriptionId], references: [id])

  @@index([companyId])
  @@index([invoiceId])
  @@index([subscriptionId])
  @@map("payments")
}

model ProductReview {
  id            String   @id
  productId     String
  companyId     String
  customerName  String
  customerEmail String?
  customerPhone String?
  rating        Int
  title         String?
  comment       String?  @db.Text
  isVerified    Boolean  @default(false)
  isApproved    Boolean  @default(false)
  helpfulCount  Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime
  companies     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  products      Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([isApproved])
  @@index([productId])
  @@index([rating])
  @@map("product_reviews")
}

model ProductVariant {
  id             String      @id
  productId      String
  name           String
  type           String      @default("color")
  sku            String?
  price          Decimal?    @db.Decimal(10, 2)
  comparePrice   Decimal?    @db.Decimal(10, 2)
  cost           Decimal?    @db.Decimal(10, 2)
  images         String?     @db.Text
  stock          Int         @default(0)
  trackInventory Boolean     @default(true)
  isActive       Boolean     @default(true)
  sortOrder      Int         @default(0)
  metadata       String?     @db.Text
  createdAt      DateTime    @default(now())
  updatedAt      DateTime
  orderItems     OrderItem[]
  products       Product     @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, sku])
  @@index([productId])
  @@index([sku])
  @@map("product_variants")
}

model Product {
  id                         String                    @id
  name                       String
  description                String?                   @db.Text
  sku                        String?
  price                      Decimal                   @db.Decimal(10, 2)
  comparePrice               Decimal?                  @db.Decimal(10, 2)
  cost                       Decimal?                  @db.Decimal(10, 2)
  images                     String?                   @db.Text
  stock                      Int                       @default(0)
  trackInventory             Boolean                   @default(true)
  weight                     Decimal?                  @db.Decimal(8, 2)
  dimensions                 String?                   @db.Text
  categoryId                 String?
  isActive                   Boolean                   @default(true)
  isFeatured                 Boolean                   @default(false)
  tags                       String?
  metadata                   String?                   @db.Text
  companyId                  String
  createdAt                  DateTime                  @default(now())
  updatedAt                  DateTime
  barcode                    String?
  easyOrdersId               String?
  easyOrdersUrl              String?
  source                     String?                   @default("manual")
  wooCommerceId              String?
  wooCommerceUrl             String?
  hasPromotedAd              Boolean                   @default(false)
  enableCheckoutForm         Boolean                   @default(true)
  showAddToCartButton        Boolean                   @default(true)
  saleStartDate              DateTime?
  saleEndDate                DateTime?
  sizeGuide                  String?                   @db.Text
  isPreOrder                 Boolean                   @default(false)
  preOrderDate               DateTime?
  preOrderMessage            String?                   @db.Text
  embedding                  String?                   @db.Text
  embeddingGeneratedAt       DateTime?
  slug                       String?
  isDropshipped              Boolean                   @default(false)
  merchantProductId          String?
  basePrice                  Decimal?                  @db.Decimal(10, 2)
  allowAffiliateMarkup       Boolean                   @default(false)
  affiliateCommission        Decimal?                  @db.Decimal(10, 2)
  commissionType             String?                   @default("PERCENTAGE")
  affiliate_products         AffiliateProduct[]
  backInStockNotifications   BackInStockNotification[]
  conversion_events          ConversionEvent[]
  facebookCatalogProducts    FacebookCatalogProduct[]
  inventories                Inventory[]
  merchantProducts           MerchantProduct[]
  orderItems                 OrderItem[]
  postResponseSettings       PostResponseSettings[]
  productAnalytics           ProductAnalytic[]
  productReviews             ProductReview[]
  productVariants            ProductVariant[]
  productVisits              ProductVisit[]
  category                   Category?                 @relation(fields: [categoryId], references: [id])
  companies                  Company                   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  purchaseInvoiceItems       PurchaseInvoiceItem[]
  purchaseOrderItems         PurchaseOrderItem[]
  recentlyVieweds            RecentlyViewed[]
  stockAlerts                StockAlert[]
  stockMovements             StockMovement[]
  whatsapp_notification_logs WhatsAppNotificationLog[]
  wishlists                  Wishlist[]

  @@unique([companyId, sku])
  @@unique([companyId, slug])
  @@index([categoryId])
  @@index([companyId])
  @@index([sku])
  @@index([wooCommerceId])
  @@map("products")
}

model ShippingZone {
  id                    String           @id
  governorates          String           @db.LongText
  price                 Decimal          @default(0.00) @db.Decimal(10, 2)
  deliveryTime          String
  isActive              Boolean          @default(true)
  companyId             String
  createdAt             DateTime         @default(now())
  updatedAt             DateTime
  deliveryTimeType      String           @default("custom")
  freeShippingThreshold Decimal?         @db.Decimal(10, 2)
  name                  String           @default("")
  pricingTiers          String?          @db.LongText
  pricingType           String           @default("flat")
  shippingMethods       ShippingMethod[]
  companies             Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([isActive])
  @@index([pricingType])
  @@map("shipping_zones")
}

model StockAlert {
  id              String              @id
  type            StockAlertType
  priority        StockAlertsPriority
  productId       String
  productName     String
  warehouseId     String
  warehouseName   String
  message         String
  currentStock    Int?
  reorderPoint    Int?
  reorderQuantity Int?
  isRead          Boolean             @default(false)
  createdAt       DateTime            @default(now())
  products        Product             @relation(fields: [productId], references: [id], onDelete: Cascade)
  warehouse       Warehouse           @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  @@index([isRead])
  @@index([priority])
  @@index([productId])
  @@index([warehouseId])
  @@map("stock_alerts")
}

model StockMovement {
  id          String               @id
  productId   String
  warehouseId String
  type        StockMovementType
  reason      StockMovementsReason
  quantity    Int
  cost        Decimal?             @db.Decimal(10, 2)
  reference   String?
  notes       String?
  userId      String?
  userName    String?
  createdAt   DateTime             @default(now())
  approvedAt  DateTime?
  approvedBy  String?
  batchNumber String?
  expiryDate  DateTime?
  isApproved  Boolean              @default(true)
  products    Product              @relation(fields: [productId], references: [id], onDelete: Cascade)
  warehouse   Warehouse            @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([productId])
  @@index([warehouseId])
  @@map("stock_movements")
}

model TaskCategory {
  id          String   @id
  name        String
  description String?
  color       String   @default("#6366f1")
  icon        String?
  order       Int      @default(0)
  isActive    Boolean  @default(true)
  companyId   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime
  companies   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  tasks       Task[]

  @@unique([companyId, name])
  @@index([companyId])
  @@index([isActive])
  @@map("task_categories")
}

model Warehouse {
  id             String          @id
  name           String
  location       String?
  type           String          @default("main")
  capacity       Int?
  isActive       Boolean         @default(true)
  companyId      String
  createdAt      DateTime        @default(now())
  updatedAt      DateTime
  inventories    Inventory[]
  stockAlerts    StockAlert[]
  stockMovements StockMovement[]
  companies      Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@map("warehouses")
}

model Wishlist {
  id         String   @id
  sessionId  String
  customerId String?
  productId  String
  variantId  String?
  companyId  String
  createdAt  DateTime @default(now())
  updatedAt  DateTime
  companies  Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  products   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([sessionId, productId, variantId, companyId])
  @@index([companyId])
  @@index([customerId])
  @@index([productId])
  @@index([sessionId])
  @@map("wishlists")
}

model WoocommerceSettings {
  id                  String    @id
  companyId           String    @unique
  storeUrl            String
  consumerKey         String    @db.Text
  consumerSecret      String    @db.Text
  syncEnabled         Boolean   @default(false)
  syncDirection       String    @default("both")
  syncInterval        Int       @default(15)
  webhookSecret       String?   @db.Text
  webhookEnabled      Boolean   @default(false)
  webhookOrderCreated String?
  webhookOrderUpdated String?
  statusMapping       String?   @db.Text
  lastSyncAt          DateTime?
  lastSyncStatus      String?   @default("never")
  lastSyncMessage     String?   @db.Text
  isActive            Boolean   @default(true)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime
  companies           Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("woocommerce_settings")
}

model WoocommerceSyncLog {
  id            String    @id
  companyId     String
  syncType      String
  syncDirection String
  status        String
  totalItems    Int       @default(0)
  successCount  Int       @default(0)
  failedCount   Int       @default(0)
  skippedCount  Int       @default(0)
  errorMessage  String?   @db.Text
  errorDetails  String?   @db.Text
  startedAt     DateTime  @default(now())
  completedAt   DateTime?
  duration      Int?
  triggeredBy   String?
  metadata      String?   @db.Text
  companies     Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([startedAt])
  @@index([status])
  @@index([syncType])
  @@map("woocommerce_sync_logs")
}

model CustomerWallet {
  id          String   @id @default(cuid())
  customerId  String   @unique
  companyId   String
  balance     Float    @default(0)
  totalEarned Float    @default(0)
  totalSpent  Float    @default(0)
  currency    String   @default("EGP")
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  customer     Customer?           @relation(fields: [customerId], references: [id])
  company      Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  transactions WalletTransaction[]

  @@index([companyId])
  @@map("customer_wallets")
}

model OrderStatusHistory {
  id           String      @id
  orderId      String?
  status       String
  oldStatus    String?
  changedBy    String?
  userName     String?
  reason       String?
  createdAt    DateTime    @default(now())
  guestOrderId String?
  guestOrder   GuestOrder? @relation(fields: [guestOrderId], references: [id], onDelete: Cascade)
  orders       Order?      @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([guestOrderId])
  @@index([orderId])
}

model CustomerLoyaltyProgram {
  id                      String                        @id
  companyId               String
  name                    String
  nameAr                  String?
  description             String?                       @db.Text
  type                    CustomerLoyaltyProgramType    @default(POINTS)
  status                  CustomerLoyaltyProgramsStatus @default(DRAFT)
  pointsPerPurchase       Decimal                       @default(1.00) @db.Decimal(10, 2)
  pointsPerReferral       Decimal                       @default(10.00) @db.Decimal(10, 2)
  pointsPerAmount         Decimal?                      @db.Decimal(10, 2)
  redemptionRate          Decimal                       @default(100.00) @db.Decimal(10, 2)
  minimumPoints           Decimal                       @default(100.00) @db.Decimal(10, 2)
  maxPointsPerTransaction Decimal?                      @db.Decimal(10, 2)
  expiryMonths            Int                           @default(12)
  rules                   String?                       @db.Text
  createdBy               String
  createdAt               DateTime                      @default(now())
  updatedAt               DateTime
  companies               Company                       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customerLoyaltyRecords  CustomerLoyaltyRecord[]
  customerLoyaltyTiers    CustomerLoyaltyTier[]

  @@index([companyId])
  @@index([status])
  @@index([type])
  @@map("customer_loyalty_programs")
}

model CustomerLoyaltyRecord {
  id                     String                       @id
  companyId              String
  customerId             String
  programId              String
  tierId                 String?
  currentPoints          Decimal                      @default(0.00) @db.Decimal(10, 2)
  totalEarned            Decimal                      @default(0.00) @db.Decimal(10, 2)
  totalRedeemed          Decimal                      @default(0.00) @db.Decimal(10, 2)
  status                 CustomerLoyaltyRecordsStatus @default(ACTIVE)
  joinDate               DateTime                     @default(now())
  lastActivity           DateTime                     @default(now())
  lastPointsEarned       DateTime?
  lastPointsRedeemed     DateTime?
  metadata               String?                      @db.Text
  createdAt              DateTime                     @default(now())
  updatedAt              DateTime
  companies              Company                      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customers              Customer                     @relation(fields: [customerId], references: [id], onDelete: Cascade)
  customerLoyaltyProgram CustomerLoyaltyProgram       @relation(fields: [programId], references: [id], onDelete: Cascade)
  customerLoyaltyTier    CustomerLoyaltyTier?         @relation(fields: [tierId], references: [id])

  @@unique([customerId, programId])
  @@index([companyId])
  @@index([customerId])
  @@index([lastActivity])
  @@index([programId])
  @@index([status])
  @@index([tierId])
  @@map("customer_loyalty_records")
}

model CustomerLoyaltyTier {
  id                     String                  @id
  companyId              String
  programId              String
  name                   String
  nameAr                 String?
  minPoints              Decimal                 @db.Decimal(10, 2)
  maxPoints              Decimal?                @db.Decimal(10, 2)
  benefits               String?                 @db.Text
  color                  String                  @default("#6366f1")
  icon                   String                  @default("crown")
  priority               Int                     @default(1)
  createdAt              DateTime                @default(now())
  updatedAt              DateTime
  customerLoyaltyRecords CustomerLoyaltyRecord[]
  companies              Company                 @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customerLoyaltyProgram CustomerLoyaltyProgram  @relation(fields: [programId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([minPoints])
  @@index([programId])
  @@map("customer_loyalty_tiers")
}

model CustomerNotificationPreference {
  id            String    @id
  companyId     String
  customerId    String    @unique
  phone         String
  orderUpdates  Boolean   @default(true)
  promotions    Boolean   @default(false)
  backInStock   Boolean   @default(true)
  priceDrops    Boolean   @default(true)
  abandonedCart Boolean   @default(true)
  isOptedIn     Boolean   @default(true)
  optedInAt     DateTime  @default(now())
  optedOutAt    DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime
  companies     Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customers     Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@unique([companyId, customerId])
  @@unique([companyId, phone])
  @@map("customer_notification_preferences")
}

model MerchantOrder {
  id              String               @id
  merchantId      String
  orderId         String               @unique
  merchantOrderId String?
  status          MerchantOrdersStatus @default(PENDING)
  items           String               @db.Text
  totalAmount     Decimal              @db.Decimal(10, 2)
  shippingAddress String?              @db.Text
  trackingNumber  String?
  syncedAt        DateTime?
  fulfilledAt     DateTime?
  notes           String?              @db.Text
  createdAt       DateTime             @default(now())
  updatedAt       DateTime
  merchants       Merchant             @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  orders          Order                @relation("OrderMerchantOrder", references: [id], onDelete: Cascade, fields: [orderId])

  @@index([merchantId])
  @@index([orderId])
  @@index([status])
  @@map("merchant_orders")
}

model MerchantProduct {
  id            String    @id
  merchantId    String
  productId     String
  merchantSku   String?
  merchantPrice Decimal   @db.Decimal(10, 2)
  stock         Int       @default(0)
  isActive      Boolean   @default(true)
  syncEnabled   Boolean   @default(true)
  lastSyncedAt  DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime
  merchants     Merchant  @relation(fields: [merchantId], references: [id], onDelete: Cascade)
  products      Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([merchantId, productId])
  @@index([merchantId])
  @@index([productId])
  @@map("merchant_products")
}

model Merchant {
  id               String            @id
  companyId        String
  name             String
  email            String            @unique
  phone            String?
  address          String?           @db.Text
  isActive         Boolean           @default(true)
  commissionRate   Float             @default(10)
  autoFulfill      Boolean           @default(false)
  apiKey           String?           @unique
  webhookUrl       String?
  settings         String?           @db.Text
  createdAt        DateTime          @default(now())
  updatedAt        DateTime
  commissions      Commission[]
  merchantOrders   MerchantOrder[]
  merchantProducts MerchantProduct[]
  companies        Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([isActive])
}

model OrderInvoiceSettings {
  id                     String   @id
  companyId              String   @unique
  autoGenerate           Boolean  @default(false)
  autoGenerateOnStatus   String?
  invoicePrefix          String   @default("INV")
  invoiceNumberFormat    String   @default("INV-YYYYMMDD-XXXXXX")
  nextInvoiceNumber      Int      @default(1)
  defaultTaxRate         Float    @default(0)
  defaultTerms           String?  @db.Text
  defaultNotes           String?  @db.Text
  defaultDueDays         Int      @default(7)
  showCompanyLogo        Boolean  @default(true)
  showTaxBreakdown       Boolean  @default(true)
  showPaymentMethod      Boolean  @default(true)
  showOrderItems         Boolean  @default(true)
  autoEmailToCustomer    Boolean  @default(false)
  emailSubject           String?
  emailBody              String?  @db.Text
  pdfPageSize            String   @default("A4")
  pdfOrientation         String   @default("portrait")
  primaryColor           String   @default("#4F46E5")
  secondaryColor         String   @default("#6B7280")
  fontFamily             String   @default("Arial")
  createdAt              DateTime @default(now())
  updatedAt              DateTime
  enableSequentialOrders Boolean  @default(false)
  nextOrderNumber        Int      @default(1)
  orderNumberFormat      String   @default("PREFIX-XXXXXX")
  orderPrefix            String   @default("ORD")
  companies              Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@map("order_invoice_settings")
}

model OrderInvoice {
  id              String    @id
  invoiceNumber   String    @unique
  orderId         String    @unique
  companyId       String
  issueDate       DateTime  @default(now())
  dueDate         DateTime?
  subtotal        Decimal   @db.Decimal(10, 2)
  tax             Decimal   @default(0.00) @db.Decimal(10, 2)
  taxRate         Float     @default(0)
  shipping        Decimal   @default(0.00) @db.Decimal(10, 2)
  discount        Decimal   @default(0.00) @db.Decimal(10, 2)
  totalAmount     Decimal   @db.Decimal(10, 2)
  currency        String    @default("EGP")
  customerName    String
  customerPhone   String?
  customerEmail   String?
  customerAddress String?   @db.Text
  city            String?
  governorate     String?
  companyName     String
  companyPhone    String?
  companyEmail    String?
  companyAddress  String?   @db.Text
  companyLogo     String?
  paymentMethod   String?
  paymentStatus   String    @default("PENDING")
  paidAt          DateTime?
  notes           String?   @db.Text
  terms           String?   @db.Text
  generatedBy     String?
  printedAt       DateTime?
  printCount      Int       @default(0)
  emailedAt       DateTime?
  emailCount      Int       @default(0)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime
  orders          Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([invoiceNumber])
  @@index([issueDate])
  @@index([orderId])
  @@index([paymentStatus])
  @@map("order_invoices")
}

model ProductVisit {
  id          String   @id @default(cuid())
  productId   String
  companyId   String
  sessionId   String
  visitedAt   DateTime @default(now())
  duration    Int?
  source      String?
  addedToCart Boolean  @default(false)
  purchased   Boolean  @default(false)
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, productId, visitedAt])
  @@index([sessionId, companyId])
  @@map("product_visits")
}

model PurchaseInvoiceItem {
  id                String          @id
  purchaseInvoiceId String
  productId         String?
  productName       String
  description       String?         @db.Text
  quantity          Decimal         @db.Decimal(10, 2)
  unitPrice         Decimal         @db.Decimal(12, 2)
  taxRate           Decimal         @default(0.00) @db.Decimal(5, 2)
  discountRate      Decimal         @default(0.00) @db.Decimal(5, 2)
  totalPrice        Decimal         @db.Decimal(12, 2)
  notes             String?         @db.Text
  createdAt         DateTime        @default(now())
  updatedAt         DateTime
  products          Product?        @relation(fields: [productId], references: [id])
  purchaseInvoice   PurchaseInvoice @relation(fields: [purchaseInvoiceId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([purchaseInvoiceId])
  @@map("purchase_invoice_items")
}

model PurchaseInvoice {
  id                   String                 @id
  companyId            String
  supplierId           String
  purchaseOrderId      String?
  invoiceNumber        String                 @unique
  invoiceDate          DateTime               @default(now())
  dueDate              DateTime?
  status               PurchaseInvoicesStatus @default(PENDING)
  subtotal             Decimal                @db.Decimal(12, 2)
  taxAmount            Decimal                @default(0.00) @db.Decimal(12, 2)
  discountAmount       Decimal                @default(0.00) @db.Decimal(12, 2)
  shippingCost         Decimal                @default(0.00) @db.Decimal(12, 2)
  totalAmount          Decimal                @db.Decimal(12, 2)
  paidAmount           Decimal                @default(0.00) @db.Decimal(12, 2)
  remainingAmount      Decimal                @db.Decimal(12, 2)
  currency             String                 @default("EGP")
  notes                String?                @db.Text
  attachments          String?                @db.Text
  createdBy            String
  createdAt            DateTime               @default(now())
  updatedAt            DateTime
  purchaseInvoiceItems PurchaseInvoiceItem[]
  companies            Company                @relation(fields: [companyId], references: [id], onDelete: Cascade)
  purchaseOrder        PurchaseOrder?         @relation(fields: [purchaseOrderId], references: [id])
  supplier             Supplier               @relation(fields: [supplierId], references: [id])
  supplierPayments     SupplierPayment[]

  @@index([companyId])
  @@index([invoiceDate])
  @@index([purchaseOrderId])
  @@index([status])
  @@index([supplierId])
  @@map("purchase_invoices")
}

model PurchaseOrderItem {
  id               String        @id
  purchaseOrderId  String
  productId        String?
  productName      String
  description      String?       @db.Text
  quantity         Decimal       @db.Decimal(10, 2)
  unitPrice        Decimal       @db.Decimal(12, 2)
  taxRate          Decimal       @default(0.00) @db.Decimal(5, 2)
  discountRate     Decimal       @default(0.00) @db.Decimal(5, 2)
  totalPrice       Decimal       @db.Decimal(12, 2)
  receivedQuantity Decimal       @default(0.00) @db.Decimal(10, 2)
  notes            String?       @db.Text
  createdAt        DateTime      @default(now())
  updatedAt        DateTime
  products         Product?      @relation(fields: [productId], references: [id])
  purchaseOrder    PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([purchaseOrderId])
  @@map("purchase_order_items")
}

model PurchaseOrder {
  id                 String               @id
  companyId          String
  supplierId         String
  orderNumber        String               @unique
  orderDate          DateTime             @default(now())
  expectedDelivery   DateTime?
  status             PurchaseOrdersStatus @default(DRAFT)
  subtotal           Decimal              @db.Decimal(12, 2)
  taxAmount          Decimal              @default(0.00) @db.Decimal(12, 2)
  discountAmount     Decimal              @default(0.00) @db.Decimal(12, 2)
  shippingCost       Decimal              @default(0.00) @db.Decimal(12, 2)
  totalAmount        Decimal              @db.Decimal(12, 2)
  currency           String               @default("EGP")
  paymentTerms       String?              @db.Text
  notes              String?              @db.Text
  attachments        String?              @db.Text
  receivedDate       DateTime?
  approvedBy         String?
  approvedAt         DateTime?
  createdBy          String
  createdAt          DateTime             @default(now())
  updatedAt          DateTime
  purchaseInvoices   PurchaseInvoice[]
  purchaseOrderItems PurchaseOrderItem[]
  companies          Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)
  supplier           Supplier             @relation(fields: [supplierId], references: [id])

  @@index([companyId])
  @@index([orderDate])
  @@index([status])
  @@index([supplierId])
  @@map("purchase_orders")
}

model ReturnReasonCategory {
  id            String                            @id
  name          String
  defaultRole   ReturnReasonCategoriesDefaultRole @default(OTHER)
  isActive      Boolean                           @default(true)
  createdAt     DateTime                          @default(now())
  updatedAt     DateTime
  companyId     String
  companies     Company                           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  returnReasons ReturnReason[]

  @@index([companyId])
  @@map("return_reason_categories")
}

model ShippingMethod {
  id           String       @id
  zoneId       String
  type         String       @default("flat_rate")
  title        String
  isEnabled    Boolean      @default(true)
  settings     String?      @db.LongText
  sortOrder    Int          @default(0)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime
  shippingZone ShippingZone @relation(fields: [zoneId], references: [id], onDelete: Cascade)

  @@index([isEnabled])
  @@index([zoneId])
  @@map("shipping_methods")
}

model SupplierPayment {
  id                String                        @id
  companyId         String
  supplierId        String
  purchaseInvoiceId String?
  paymentNumber     String                        @unique
  paymentDate       DateTime                      @default(now())
  amount            Decimal                       @db.Decimal(12, 2)
  paymentMethod     SupplierPaymentsPaymentMethod
  referenceNumber   String?
  bankName          String?
  checkNumber       String?
  checkDate         DateTime?
  notes             String?                       @db.Text
  attachments       String?                       @db.Text
  createdBy         String
  createdAt         DateTime                      @default(now())
  updatedAt         DateTime
  companies         Company                       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  purchaseInvoice   PurchaseInvoice?              @relation(fields: [purchaseInvoiceId], references: [id])
  supplier          Supplier                      @relation(fields: [supplierId], references: [id])

  @@index([companyId])
  @@index([paymentDate])
  @@index([purchaseInvoiceId])
  @@index([supplierId])
  @@map("supplier_payments")
}

model Supplier {
  id                 String            @id
  companyId          String
  name               String
  contactPerson      String?
  email              String?
  phone              String?
  mobile             String?
  address            String?           @db.Text
  city               String?
  country            String?           @default("Egypt")
  taxNumber          String?
  commercialRegister String?
  paymentTerms       String?           @db.Text
  creditLimit        Decimal?          @db.Decimal(12, 2)
  currentBalance     Decimal           @default(0.00) @db.Decimal(12, 2)
  rating             Int?              @default(0)
  notes              String?           @db.Text
  isActive           Boolean           @default(true)
  createdAt          DateTime          @default(now())
  updatedAt          DateTime
  createdBy          String?
  purchaseInvoices   PurchaseInvoice[]
  purchaseOrders     PurchaseOrder[]
  supplierPayments   SupplierPayment[]
  companies          Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([isActive])
  @@map("suppliers")
}